{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Manager</title>
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
</head>
<body>

    <!-- COMPONENT 1 : Toolbar (fixe en haut) -->
    {% include "components/toolbar.html" %}

    <!-- Mobile overlay for sidebar -->
    <div class="fm-mobile-overlay" id="fm-mobile-overlay"></div>

    <!-- COMPONENT 4 : New File/Folder Modal -->
    {% include "components/new_file_modal.html" %}

    <!-- COMPONENT 5 : Action Modal (Copy/Move/Rename) -->
    {% include "components/action_modal.html" %}

    <!-- COMPONENT 6 : Permissions Modal -->
    {% include "components/permissions_modal.html" %}

    <!-- COMPONENT 7 : Compress Modal -->
    {% include "components/compress_modal.html" %}

    <!-- COMPONENT 8 : Delete Modal -->
    {% include "components/delete_modal.html" %}

    <!-- Zone principale sous la toolbar -->
    <div class="fm-body">

        <!-- COMPONENT 2 : Sidebar (scroll interne) -->
        <aside class="fm-sidebar-wrapper" id="fm-sidebar-wrapper">
            {% include "components/sidebar.html" %}
        </aside>

        <!-- COMPONENT 3 : File list (scroll interne) -->
        <main class="fm-main-wrapper">
            {% include "components/file_list.html" %}
        </main>

    </div>

    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'js/htmx.min.js' %}"></script>
    <script src="{% static 'js/filemanager.js' %}"></script>
    <script>
        // Mobile menu toggle functionality
        document.addEventListener('DOMContentLoaded', function() {
            const menuToggle = document.getElementById('fm-mobile-menu-toggle');
            const sidebar = document.getElementById('fm-sidebar-wrapper');
            const overlay = document.getElementById('fm-mobile-overlay');

            if (menuToggle && sidebar && overlay) {
                menuToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('mobile-open');
                    overlay.classList.toggle('active');
                });

                overlay.addEventListener('click', function() {
                    sidebar.classList.remove('mobile-open');
                    overlay.classList.remove('active');
                });

                // Close sidebar when pressing Escape key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        sidebar.classList.remove('mobile-open');
                        overlay.classList.remove('active');
                    }
                });
            }

            // New File/Folder Modal functionality
            const modalOverlay = document.getElementById('fm-modal-overlay');
            const modal = document.getElementById('fm-new-file-modal');
            const modalTitle = document.getElementById('fm-modal-title');
            const modalCreateBtn = document.getElementById('fm-modal-create');
            const modalCancelBtn = document.getElementById('fm-modal-cancel');
            const modalCloseBtn = document.getElementById('fm-modal-close');
            const itemNameInput = document.getElementById('fm-item-name');
            const itemPathInput = document.getElementById('fm-item-path');
            
            let currentModalType = 'file'; // 'file' or 'folder'

            // Function to open modal
            function openModal(type) {
                currentModalType = type;
                modalTitle.textContent = type === 'folder' ? 'New Folder' : 'New File';
                modalCreateBtn.textContent = type === 'folder' ? 'Create New Folder' : 'Create New File';
                
                // Update placeholder based on type
                if (type === 'folder') {
                    itemNameInput.placeholder = '(ex: my-folder, documents, projects)';
                } else {
                    itemNameInput.placeholder = '(ex: file.txt, file.html, file.php)';
                }
                
                // Clear previous input
                itemNameInput.value = '';
                
                // Show modal with animation
                modalOverlay.classList.add('active');
                itemNameInput.focus();
                
                // Prevent body scroll
                document.body.style.overflow = 'hidden';
            }

            // Function to close modal
            function closeModal() {
                modalOverlay.classList.remove('active');
                document.body.style.overflow = '';
            }

            // Function to create item
            function createItem() {
                const itemName = itemNameInput.value.trim();
                const itemPath = itemPathInput.value.trim();
                
                if (!itemName) {
                    itemNameInput.focus();
                    itemNameInput.style.borderColor = '#e74c3c';
                    setTimeout(() => {
                        itemNameInput.style.borderColor = '';
                    }, 2000);
                    return;
                }
                
                // Here you would typically send an AJAX request to create the file/folder
                console.log(`Creating ${currentModalType}:`, {
                    name: itemName,
                    path: itemPath
                });
                
                // For demo purposes, just close the modal
                closeModal();
                
                // In a real implementation, you would:
                // 1. Send POST request to your backend
                // 2. On success, refresh the file list
                // 3. Show success message
            }

            // Event listeners for toolbar buttons
            const newFileBtn = document.querySelector('[data-action="new-file"]');
            const newFolderBtn = document.querySelector('[data-action="new-folder"]');
            
            if (newFileBtn) {
                newFileBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    openModal('file');
                });
            }
            
            if (newFolderBtn) {
                newFolderBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    openModal('folder');
                });
            }

            // Modal button event listeners
            modalCreateBtn.addEventListener('click', createItem);
            
            modalCancelBtn.addEventListener('click', closeModal);
            modalCloseBtn.addEventListener('click', closeModal);
            
            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modalOverlay.classList.contains('active')) {
                    closeModal();
                }
            });
            
            // Handle Enter key in input
            itemNameInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    createItem();
                }
            });

            // Action Modal (Copy/Move/Rename) functionality
            const actionModalOverlay = document.getElementById('fm-action-modal-overlay');
            const actionModal = document.getElementById('fm-action-modal');
            const actionModalTitle = document.getElementById('fm-action-modal-title');
            const actionModalCloseBtn = document.getElementById('fm-action-modal-close');
            const actionModalConfirmBtn = document.getElementById('fm-action-modal-confirm');
            const actionModalCancelBtn = document.getElementById('fm-action-modal-cancel');
            const actionInput = document.getElementById('fm-action-input');
            const actionLabel = document.getElementById('fm-action-label');
            const selectedFilesList = document.getElementById('fm-selected-files-list');
            
            let currentActionType = 'copy'; // 'copy', 'move', or 'rename'

            // Function to open action modal
            function openActionModal(type, selectedFiles = []) {
                currentActionType = type;
                
                // Update modal content based on action type
                if (type === 'copy') {
                    actionModalTitle.textContent = 'Copy';
                    actionModalConfirmBtn.textContent = 'Copy Files';
                    actionLabel.textContent = 'New Path:';
                    actionInput.placeholder = '(ex: /path/to/destination)';
                } else if (type === 'move') {
                    actionModalTitle.textContent = 'Move';
                    actionModalConfirmBtn.textContent = 'Move Files';
                    actionLabel.textContent = 'New Path:';
                    actionInput.placeholder = '(ex: /path/to/destination)';
                } else if (type === 'rename') {
                    actionModalTitle.textContent = 'Rename';
                    actionModalConfirmBtn.textContent = 'Rename';
                    actionLabel.textContent = 'New Name:';
                    actionInput.placeholder = '(ex: new-name.txt)';
                }
                
                // Update selected files list
                updateSelectedFilesList(selectedFiles);
                
                // Clear input field
                actionInput.value = '';
                
                // Show modal with animation
                actionModalOverlay.classList.add('active');
                actionInput.focus();
                
                // Prevent body scroll
                document.body.style.overflow = 'hidden';
            }

            // Function to update selected files list
            function updateSelectedFilesList(files) {
                if (!files || files.length === 0) {
                    selectedFilesList.innerHTML = '<div class="fm-modal__selected-item">No files selected</div>';
                    return;
                }
                
                let html = '';
                files.forEach(file => {
                    const isFolder = file.type === 'folder';
                    const iconClass = isFolder ? 'fm-modal__folder-icon' : 'fm-modal__file-icon';
                    const iconPath = isFolder 
                        ? '<path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>'
                        : '<path d="M4 0h5.293A1 1 0 0 1 10 .293L13.707 4a1 1 0 0 1 .293.707V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2zm5.5 1.5v2a1 1 0 0 0 1 1h2l-3-3z"/>';
                    
                    html += `
                        <div class="fm-modal__selected-item">
                            <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" class="${iconClass}">
                                ${iconPath}
                            </svg>
                            <span class="fm-modal__file-name">${file.name}</span>
                        </div>
                    `;
                });
                
                selectedFilesList.innerHTML = html;
            }

            // Function to close action modal
            function closeActionModal() {
                actionModalOverlay.classList.remove('active');
                document.body.style.overflow = '';
            }

            // Function to execute action
            function executeAction() {
                const newValue = actionInput.value.trim();
                
                if (!newValue) {
                    actionInput.focus();
                    actionInput.style.borderColor = '#e74c3c';
                    setTimeout(() => {
                        actionInput.style.borderColor = '';
                    }, 2000);
                    return;
                }
                
                // Here you would typically send an AJAX request to execute action
                console.log(`Executing ${currentActionType}:`, {
                    destination: newValue,
                    files: 'selected files would be here'
                });
                
                // For demo purposes, just close modal
                closeActionModal();
                
                // In a real implementation, you would:
                // 1. Send POST request to your backend
                // 2. On success, refresh the file list
                // 3. Show success message
            }

            // Event listeners for action buttons
            const copyBtn = document.querySelector('[data-action="copy"]');
            const moveBtn = document.querySelector('[data-action="move"]');
            const renameBtn = document.querySelector('[data-action="rename"]');
            
            if (copyBtn) {
                copyBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    // In a real implementation, you'd get selected files
                    const demoFiles = [
                        { name: 'file.txt', type: 'file' },
                        { name: 'document.pdf', type: 'file' },
                        { name: 'images', type: 'folder' }
                    ];
                    openActionModal('copy', demoFiles);
                });
            }
            
            if (moveBtn) {
                moveBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    // In a real implementation, you'd get selected files
                    const demoFiles = [
                        { name: 'file.txt', type: 'file' },
                        { name: 'document.pdf', type: 'file' },
                        { name: 'images', type: 'folder' }
                    ];
                    openActionModal('move', demoFiles);
                });
            }
            
            if (renameBtn) {
                renameBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    // In a real implementation, you'd get selected files
                    const demoFiles = [
                        { name: 'file.txt', type: 'file' }
                    ];
                    openActionModal('rename', demoFiles);
                });
            }

            // Action modal button event listeners
            actionModalConfirmBtn.addEventListener('click', executeAction);
            
            actionModalCancelBtn.addEventListener('click', closeActionModal);
            actionModalCloseBtn.addEventListener('click', closeActionModal);
            
            // Close action modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && actionModalOverlay.classList.contains('active')) {
                    closeActionModal();
                }
            });
            
            // Handle Enter key in action modal input
            actionInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    executeAction();
                }
            });

            // Permissions Modal functionality
            const permissionsModalOverlay = document.getElementById('fm-permissions-modal-overlay');
            const permissionsModal = document.getElementById('fm-permissions-modal');
            const permissionsModalCloseBtn = document.getElementById('fm-permissions-modal-close');
            const permissionsModalConfirmBtn = document.getElementById('fm-permissions-modal-confirm');
            const permissionsModalCancelBtn = document.getElementById('fm-permissions-modal-cancel');
            const permissionsSelectedList = document.getElementById('fm-permissions-selected-list');
            const permissionsNumericInput = document.getElementById('fm-permissions-numeric');
            
            // Permission checkboxes
            const ownerRead = document.getElementById('perm-owner-read');
            const ownerWrite = document.getElementById('perm-owner-write');
            const ownerExecute = document.getElementById('perm-owner-execute');
            const groupRead = document.getElementById('perm-group-read');
            const groupWrite = document.getElementById('perm-group-write');
            const groupExecute = document.getElementById('perm-group-execute');
            const otherRead = document.getElementById('perm-other-read');
            const otherWrite = document.getElementById('perm-other-write');
            const otherExecute = document.getElementById('perm-other-execute');

            // Function to open permissions modal
            function openPermissionsModal(selectedFiles = []) {
                // Update selected files list
                updatePermissionsSelectedFilesList(selectedFiles);
                
                // Reset checkboxes to default values
                ownerRead.checked = true;
                ownerWrite.checked = true;
                ownerExecute.checked = false;
                groupRead.checked = true;
                groupWrite.checked = false;
                groupExecute.checked = false;
                otherRead.checked = true;
                otherWrite.checked = false;
                otherExecute.checked = false;
                
                // Update numeric value
                updateNumericValue();
                
                // Show modal with animation
                permissionsModalOverlay.classList.add('active');
                
                // Prevent body scroll
                document.body.style.overflow = 'hidden';
            }

            // Function to update selected files list for permissions
            function updatePermissionsSelectedFilesList(files) {
                if (!files || files.length === 0) {
                    permissionsSelectedList.innerHTML = '<div class="fm-modal__selected-item">No files selected</div>';
                    return;
                }
                
                let html = '';
                files.forEach(file => {
                    const isFolder = file.type === 'folder';
                    const iconClass = isFolder ? 'fm-modal__folder-icon' : 'fm-modal__file-icon';
                    const iconPath = isFolder 
                        ? '<path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>'
                        : '<path d="M4 0h5.293A1 1 0 0 1 10 .293L13.707 4a1 1 0 0 1 .293.707V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2zm5.5 1.5v2a1 1 0 0 0 1 1h2l-3-3z"/>';
                    
                    html += `
                        <div class="fm-modal__selected-item">
                            <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" class="${iconClass}">
                                ${iconPath}
                            </svg>
                            <span class="fm-modal__file-name">${file.name}</span>
                        </div>
                    `;
                });
                
                permissionsSelectedList.innerHTML = html;
            }

            // Function to update numeric value based on checkboxes
            function updateNumericValue() {
                let ownerValue = 0;
                let groupValue = 0;
                let otherValue = 0;
                
                // Calculate Owner value
                if (ownerRead.checked) ownerValue += 4;
                if (ownerWrite.checked) ownerValue += 2;
                if (ownerExecute.checked) ownerValue += 1;
                
                // Calculate Group value
                if (groupRead.checked) groupValue += 4;
                if (groupWrite.checked) groupValue += 2;
                if (groupExecute.checked) groupValue += 1;
                
                // Calculate Other value
                if (otherRead.checked) otherValue += 4;
                if (otherWrite.checked) otherValue += 2;
                if (otherExecute.checked) otherValue += 1;
                
                // Update numeric input
                const totalValue = (ownerValue * 100) + (groupValue * 10) + otherValue;
                permissionsNumericInput.value = totalValue.toString();
                
                // Update individual totals
                const ownerTotal = document.querySelector('.fm-permissions__group:nth-child(1) .fm-permissions__total');
                const groupTotal = document.querySelector('.fm-permissions__group:nth-child(2) .fm-permissions__total');
                const otherTotal = document.querySelector('.fm-permissions__group:nth-child(3) .fm-permissions__total');
                
                if (ownerTotal) ownerTotal.textContent = ownerValue.toString();
                if (groupTotal) groupTotal.textContent = groupValue.toString();
                if (otherTotal) otherTotal.textContent = otherValue.toString();
            }

            // Function to update checkboxes based on numeric value
            function updateCheckboxesFromNumeric() {
                const value = parseInt(permissionsNumericInput.value) || 0;
                
                const ownerValue = Math.floor(value / 100);
                const groupValue = Math.floor((value % 100) / 10);
                const otherValue = value % 10;
                
                // Update Owner checkboxes
                ownerRead.checked = (ownerValue & 4) !== 0;
                ownerWrite.checked = (ownerValue & 2) !== 0;
                ownerExecute.checked = (ownerValue & 1) !== 0;
                
                // Update Group checkboxes
                groupRead.checked = (groupValue & 4) !== 0;
                groupWrite.checked = (groupValue & 2) !== 0;
                groupExecute.checked = (groupValue & 1) !== 0;
                
                // Update Other checkboxes
                otherRead.checked = (otherValue & 4) !== 0;
                otherWrite.checked = (otherValue & 2) !== 0;
                otherExecute.checked = (otherValue & 1) !== 0;
                
                // Update individual totals
                updateNumericValue();
            }

            // Function to close permissions modal
            function closePermissionsModal() {
                permissionsModalOverlay.classList.remove('active');
                document.body.style.overflow = '';
            }

            // Function to apply permissions
            function applyPermissions() {
                // Here you would typically send an AJAX request to apply permissions
                const permissions = {
                    owner: {
                        read: ownerRead.checked,
                        write: ownerWrite.checked,
                        execute: ownerExecute.checked
                    },
                    group: {
                        read: groupRead.checked,
                        write: groupWrite.checked,
                        execute: groupExecute.checked
                    },
                    other: {
                        read: otherRead.checked,
                        write: otherWrite.checked,
                        execute: otherExecute.checked
                    },
                    numeric: permissionsNumericInput.value
                };
                
                console.log('Applying permissions:', permissions);
                
                // For demo purposes, just close modal
                closePermissionsModal();
                
                // In a real implementation, you would:
                // 1. Send POST request to your backend
                // 2. On success, refresh file list
                // 3. Show success message
            }

            // Event listener for permissions button
            const permissionsBtn = document.querySelector('[data-action="permissions"]');
            
            if (permissionsBtn) {
                permissionsBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    // In a real implementation, you'd get selected files
                    const demoFiles = [
                        { name: 'file.txt', type: 'file' },
                        { name: 'images', type: 'folder' }
                    ];
                    openPermissionsModal(demoFiles);
                });
            }

            // Add event listeners to all checkboxes
            [ownerRead, ownerWrite, ownerExecute, groupRead, groupWrite, groupExecute, otherRead, otherWrite, otherExecute].forEach(checkbox => {
                checkbox.addEventListener('change', updateNumericValue);
            });

            // Event listener for numeric input
            permissionsNumericInput.addEventListener('input', updateCheckboxesFromNumeric);

            // Permissions modal button event listeners
            
            permissionsModalConfirmBtn.addEventListener('click', applyPermissions);
            
            permissionsModalCancelBtn.addEventListener('click', closePermissionsModal);
            permissionsModalCloseBtn.addEventListener('click', closePermissionsModal);
            
            // Close permissions modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && permissionsModalOverlay.classList.contains('active')) {
                    closePermissionsModal();
                }
            });

            // Compress Modal functionality
            const compressModalOverlay = document.getElementById('fm-compress-modal-overlay');
            const compressModal = document.getElementById('fm-compress-modal');
            const compressModalCloseBtn = document.getElementById('fm-compress-modal-close');
            const compressModalConfirmBtn = document.getElementById('fm-compress-modal-confirm');
            const compressModalCancelBtn = document.getElementById('fm-compress-modal-cancel');
            const compressSelectedList = document.getElementById('fm-compress-selected-list');
            const compressNameInput = document.getElementById('fm-compress-name');
            const formatRadios = document.querySelectorAll('input[name="archive-format"]');
            const includeHiddenCheckbox = document.getElementById('compress-include-hidden');
            const followSymlinksCheckbox = document.getElementById('compress-follow-symlinks');
            const preservePermissionsCheckbox = document.getElementById('compress-preserve-permissions');

            // Function to open compress modal
            function openCompressModal(selectedFiles = []) {
                // Update selected files list
                updateCompressSelectedFilesList(selectedFiles);
                
                // Reset to default values
                compressNameInput.value = 'archive.zip';
                document.querySelector('input[name="archive-format"][value="zip"]').checked = true;
                includeHiddenCheckbox.checked = true;
                followSymlinksCheckbox.checked = false;
                preservePermissionsCheckbox.checked = true;
                
                // Show modal with animation
                compressModalOverlay.classList.add('active');
                compressNameInput.focus();
                
                // Prevent body scroll
                document.body.style.overflow = 'hidden';
            }

            // Function to update selected files list for compress
            function updateCompressSelectedFilesList(files) {
                if (!files || files.length === 0) {
                    compressSelectedList.innerHTML = '<div class="fm-modal__selected-item">No files selected</div>';
                    return;
                }
                
                let html = '';
                files.forEach(file => {
                    const isFolder = file.type === 'folder';
                    const iconClass = isFolder ? 'fm-modal__folder-icon' : 'fm-modal__file-icon';
                    const iconPath = isFolder 
                        ? '<path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>'
                        : '<path d="M4 0h5.293A1 1 0 0 1 10 .293L13.707 4a1 1 0 0 1 .293.707V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2zm5.5 1.5v2a1 1 0 0 0 1 1h2l-3-3z"/>';
                    
                    html += `
                        <div class="fm-modal__selected-item">
                            <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" class="${iconClass}">
                                ${iconPath}
                            </svg>
                            <span class="fm-modal__file-name">${file.name}</span>
                        </div>
                    `;
                });
                
                compressSelectedList.innerHTML = html;
            }

            // Function to close compress modal
            function closeCompressModal() {
                compressModalOverlay.classList.remove('active');
                document.body.style.overflow = '';
            }

            // Function to compress files
            function compressFiles() {
                const archiveName = compressNameInput.value.trim();
                const selectedFormat = document.querySelector('input[name="archive-format"]:checked')?.value || 'zip';
                
                if (!archiveName) {
                    compressNameInput.focus();
                    compressNameInput.style.borderColor = '#e74c3c';
                    setTimeout(() => {
                        compressNameInput.style.borderColor = '';
                    }, 2000);
                    return;
                }
                
                // Get compression options
                const options = {
                    includeHidden: includeHiddenCheckbox.checked,
                    followSymlinks: followSymlinksCheckbox.checked,
                    preservePermissions: preservePermissionsCheckbox.checked
                };
                
                // Here you would typically send an AJAX request to compress files
                console.log('Compressing files:', {
                    archiveName: archiveName,
                    format: selectedFormat,
                    options: options
                });
                
                // For demo purposes, just close modal
                closeCompressModal();
                
                // In a real implementation, you would:
                // 1. Send POST request to your backend
                // 2. On success, refresh file list
                // 3. Show success message
            }

            // Event listener for compress button
            const compressBtn = document.querySelector('[data-action="compress"]');
            
            if (compressBtn) {
                compressBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    // In a real implementation, you'd get selected files
                    const demoFiles = [
                        { name: 'file.txt', type: 'file' },
                        { name: 'document.pdf', type: 'file' },
                        { name: 'images', type: 'folder' }
                    ];
                    openCompressModal(demoFiles);
                });
            }

            // Update archive name when format changes
            formatRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const currentName = compressNameInput.value;
                    const baseName = currentName.replace(/\.(zip|tar|tar\.gz|7z)$/i, '');
                    compressNameInput.value = baseName + '.' + this.value;
                });
            });

            // Compress modal button event listeners
            compressModalConfirmBtn.addEventListener('click', compressFiles);
            
            compressModalCancelBtn.addEventListener('click', closeCompressModal);
            compressModalCloseBtn.addEventListener('click', closeCompressModal);
            
            // Close compress modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && compressModalOverlay.classList.contains('active')) {
                    closeCompressModal();
                }
            });
            
            // Handle Enter key in archive name input
            compressNameInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    compressFiles();
                }
            });

            // Delete Modal functionality
            const deleteModalOverlay = document.getElementById('fm-delete-modal-overlay');
            const deleteModal = document.getElementById('fm-delete-modal');
            const deleteModalCloseBtn = document.getElementById('fm-delete-modal-close');
            const deleteModalConfirmBtn = document.getElementById('fm-delete-modal-confirm');
            const deleteModalCancelBtn = document.getElementById('fm-delete-modal-cancel');
            const deleteSelectedList = document.getElementById('fm-delete-selected-list');
            const deletePermanentlyCheckbox = document.getElementById('delete-permanently');
            const deleteConfirmCheckbox = document.getElementById('delete-confirm');

            // Function to open delete modal
            function openDeleteModal(selectedFiles = []) {
                // Update selected files list
                updateDeleteSelectedFilesList(selectedFiles);
                
                // Reset checkboxes
                deletePermanentlyCheckbox.checked = false;
                deleteConfirmCheckbox.checked = false;
                
                // Show modal with animation
                deleteModalOverlay.classList.add('active');
                
                // Prevent body scroll
                document.body.style.overflow = 'hidden';
            }

            // Function to update selected files list for delete
            function updateDeleteSelectedFilesList(files) {
                if (!files || files.length === 0) {
                    deleteSelectedList.innerHTML = '<div class="fm-modal__selected-item">No files selected</div>';
                    return;
                }
                
                let html = '';
                files.forEach(file => {
                    const isFolder = file.type === 'folder';
                    const iconClass = isFolder ? 'fm-modal__folder-icon' : 'fm-modal__file-icon';
                    const iconPath = isFolder 
                        ? '<path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>'
                        : '<path d="M4 0h5.293A1 1 0 0 1 10 .293L13.707 4a1 1 0 0 1 .293.707V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2zm5.5 1.5v2a1 1 0 0 0 1 1h2l-3-3z"/>';
                    
                    html += `
                        <div class="fm-modal__selected-item">
                            <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" class="${iconClass}">
                                ${iconPath}
                            </svg>
                            <span class="fm-modal__file-name">${file.name}</span>
                        </div>
                    `;
                });
                
                deleteSelectedList.innerHTML = html;
            }

            // Function to close delete modal
            function closeDeleteModal() {
                deleteModalOverlay.classList.remove('active');
                document.body.style.overflow = '';
            }

            // Function to delete files
            function deleteFiles() {
                // Check if user confirmed understanding
                if (!deleteConfirmCheckbox.checked) {
                    deleteConfirmCheckbox.focus();
                    deleteConfirmCheckbox.style.borderColor = '#e74c3c';
                    setTimeout(() => {
                        deleteConfirmCheckbox.style.borderColor = '';
                    }, 2000);
                    return;
                }
                
                // Get delete options
                const options = {
                    permanently: deletePermanentlyCheckbox.checked,
                    confirmed: deleteConfirmCheckbox.checked
                };
                
                // Here you would typically send an AJAX request to delete files
                console.log('Deleting files:', {
                    options: options
                });
                
                // For demo purposes, just close modal
                closeDeleteModal();
                
                // In a real implementation, you would:
                // 1. Send POST request to your backend
                // 2. On success, refresh file list
                // 3. Show success message
            }

            // Event listener for delete button
            const deleteBtn = document.querySelector('[data-action="delete"]');
            
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    // In a real implementation, you'd get selected files
                    const demoFiles = [
                        { name: 'file.txt', type: 'file' },
                        { name: 'document.pdf', type: 'file' },
                        { name: 'images', type: 'folder' }
                    ];
                    openDeleteModal(demoFiles);
                });
            }

            // Delete modal button event listeners
            deleteModalConfirmBtn.addEventListener('click', deleteFiles);
            
            deleteModalCancelBtn.addEventListener('click', closeDeleteModal);
            deleteModalCloseBtn.addEventListener('click', closeDeleteModal);
            
            // Close delete modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && deleteModalOverlay.classList.contains('active')) {
                    closeDeleteModal();
                }
            });
        });
    </script>
</body>
</html>